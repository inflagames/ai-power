(()=>{"use strict";(()=>{const t=3/4,e=1024,i=768,s="0",n="8",r="10",o="11";class h{constructor(){this.subscriptions=[],this.open=!0}emit(t={}){for(let e=0;e<this.subscriptions.length;e++)this.callFunction(this.subscriptions[e],t)}async callFunction(t,e){t(e)}pipe(...t){let e=this;for(const i of t){const t=new h;e.on((e=>i(e,t))),e=t}return e}unsub(t){this.subscriptions=this.subscriptions.filter((e=>e!==t))}on(t){this.subscriptions.push(t)}}class a{constructor(t,e=0,i=0,s=0,n=0){this.destroy=new h,this.eventEmitter=t,this.x=e,this.y=i,this.width=s,this.height=n,this.lastMousePosition=null,this.isMouseHover=!1,this.id=1e6*Math.random()}set eventEmitter(t){this._eventEmitter=t?t.pipe(function(t){let e=!1;const i=()=>{e=!0,t.unsub(i)};return t.on(i),(t,i)=>{e&&(i.subscriptions=[]),i.emit(t)}}(this.destroy)):t}get eventEmitter(){return this._eventEmitter}render(t){}listenerEvent(t,e){var i;this.eventEmitter.pipe((i=e=>e.event===t,(t,e)=>{i(t)&&e.emit(t)})).on((t=>{(t&&this.validateMouseEventPropagation(t.position,t.event)||this.validateKeyboardEventPropagation(t.event))&&e(t)}))}validateKeyboardEventPropagation(t){return t===r||t===o||"9"===t}validateMouseEventPropagation(t,e){return"5"===e||e===n||"7"===e||"9"===e||(this.isPositionInside(this.lastMousePosition)&&!this.isPositionInside(t)&&this.eventEmitter.emit({event:n}),this.lastMousePosition=t,this.isMouseHover=this.isPositionInside(t))}isPositionInside(t){return t&&t.x>=this.x&&t.x<=this.x+this.width&&t.y>=this.y&&t.y<=this.y+this.height}}class c extends a{constructor(t,e){super(e),this.navigator=t,this.backgroundColor="#f00",this.elements=[]}render(t){this.cleanCanvas(t);for(const e of this.elements)e.render(t)}cleanCanvas(t){t.rect(0,0,this.width,this.height),t.fillStyle=this.backgroundColor,t.fill()}validateEventPropagation(t,e){const i=super.validateEventPropagation(t,e);if(i)for(const i of this.elements)if(i.validateEventPropagation(t,e))return!1;return i}}function l(t,e,i){const s=function(t,e){return{x:t.x*Math.cos(e)-t.y*Math.sin(e),y:t.x*Math.sin(e)+t.y*Math.cos(e)}}(t,i);return{x:e.x+s.x,y:e.y-s.y}}function u(t){return t*window.currentWidth/e}function d(t){return t*e/window.currentWidth}function y(t,e){if(t.length<3||e.length<3)return!1;const i=[...p(t),...p(e)];for(const s of i){const i=m(t,s),n=m(e,s);if(!(i.min>n.min&&i.min<n.max||i.max>n.min&&i.max<n.max||n.min>i.min&&n.min<i.max||n.max>i.min&&n.max<i.max||i.min===n.min&&i.max===n.max))return!1}return!0}function x(t){if(0===t.x&&0===t.y)return{x:0,y:0};const e=Math.sqrt(t.x*t.x+t.y*t.y);return{x:t.x/e,y:t.y/e}}function p(t){if(t.length<=1)return[];const e=[];for(let i=1;i<t.length;i++)e.push({x:t[i].x-t[i-1].x,y:t[i-1].y-t[i].y});return e.push({x:t[0].x-t[t.length-1].x,y:t[t.length-1].y-t[0].y}),e}function m(t,e){let i=g(e,t[0]),s=i;for(let n=1;n<t.length;n++){const r=g(e,t[n]);i=Math.min(i,r),s=Math.max(s,r)}return{min:i,max:s}}function g(t,e){return(e.x*t.x+e.y*t.y)/(t.x*t.x+t.y*t.y)}class v extends a{constructor(t,e=0,i=0,s=0,n=0){super(t,e,i,s,n),this.backgroundColor="#00f",this.rotation=0,this.directionVector={x:1,y:0},this.scaleShape=4,this.brakedShape=null}updateCoordinates(t,e){this.x=t||this.x,this.y=e||this.y}render(t){const e=this.getProjection();for(const i of e){const e=i.points;if(0!==e.length){t.beginPath(),t.moveTo(u(e[0].x),u(e[0].y));for(let i=1;i<e.length;i++)t.lineTo(u(e[i].x),u(e[i].y));t.closePath(),t.fillStyle=i.background,this.brakedShape||t.stroke(),t.fill()}}}animate(){this.moveBrakedPiece()}brakeShapes(){const t=this.shipShape().shapes;this.brakedShape={shapes:[]};for(const e of t)this.brakedShape={shapes:[...this.brakedShape.shapes,...this.brakeShape(e)]};for(const t of this.brakedShape.shapes){const e=this.shapeCenter(t.points),i=(Math.random()+.5)/Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));t.vector={x:e.x*i,y:e.y*i}}}brakeShape(t){if(0===t.points.length)return t.points;const{min:e,max:i}=this.coverBox(t.points),s=[];let n=Math.ceil((i.x-e.x)*(i.y-e.y)/2);n=Math.min(n,150);for(let r=0;r<n;r++){const n={x:(i.x-e.x)*Math.random()+e.x,y:(i.y-e.y)*Math.random()+e.y};s.push({points:new Array(3).fill(null).map((()=>({x:n.x+2.5*Math.random(),y:n.y+2.5*Math.random()}))),background:t.background})}return s}shapeCenter(t){const{min:e,max:i}=this.coverBox(t);return{x:(i.x+e.x)/2,y:(i.y+e.y)/2}}coverBox(t){const e={x:t[0].x,y:t[0].y},i={...e};for(let s=1;s<t.length;s++)e.x=Math.min(e.x,t[s].x),e.y=Math.min(e.y,t[s].y),i.x=Math.max(i.x,t[s].x),i.y=Math.max(i.y,t[s].y);return{min:e,max:i}}moveBrakedPiece(){if(this.brakedShape)for(const t of this.brakedShape.shapes)t.points=t.points.map((e=>({x:e.x+t.vector.x,y:e.y+t.vector.y}))),t.background=this.reduceOpacity(t.background,30)}reduceOpacity(t,e){let i=this.getOpacity(t);return i=Math.min(255,Math.max(i-e,0)),i=i.toString(16),`#${t.substr(1,6)}${(i.length<2?"0":"")+i}`}getOpacity(t){return t.length>7?parseInt(t.substr(7,2),16):255}getProjection(){const t=(e=this.directionVector,Math.atan2(e.y,e.x)+Math.PI/2);var e;const i=this.shipShape().shapes,s={x:this.x,y:this.y},n=[];for(const e of i){const i=e.points.map((t=>({x:t.x*this.scaleShape,y:t.y*this.scaleShape})));for(let e=0;e<i.length;e++)i[e]=l(i[e],s,t);n.push({...e,points:i})}return n}shipShape(){return{shapes:[]}}}const f=JSON.parse('{"shapes":[{"background":"#cccccc","points":[{"x":0.5,"y":-6.3},{"x":1.1,"y":-5.5},{"x":1.7,"y":-2},{"x":1.8,"y":-0.1},{"x":1.9,"y":3},{"x":1.4,"y":3.8},{"x":1.4,"y":5.3},{"x":0.4,"y":5.3},{"x":0.3,"y":3.8},{"x":-0.3,"y":3.8},{"x":-0.4,"y":5.3},{"x":-1.4,"y":5.3},{"x":-1.4,"y":3.8},{"x":-1.9,"y":3},{"x":-1.8,"y":-0.1},{"x":-1.7,"y":-2},{"x":-1.1,"y":-5.5},{"x":-0.5,"y":-6.3},{"x":0,"y":-6.5}]},{"background":"#808080","points":[{"x":-5.3,"y":3},{"x":-2.3,"y":3.9},{"x":-2.3,"y":0.7},{"x":-5.3,"y":1.6}]},{"background":"#808080","points":[{"x":5.3,"y":3},{"x":2.3,"y":3.9},{"x":2.3,"y":0.7},{"x":5.3,"y":1.6}]},{"background":"#cccccc","points":[{"x":2.4,"y":0.7},{"x":2.3,"y":4},{"x":1.4,"y":4.3},{"x":-1.4,"y":4.3},{"x":-2.3,"y":4},{"x":-2.4,"y":0.7},{"x":-1.8,"y":0.1},{"x":1.8,"y":0.1}]},{"background":"#b3b3b3","points":[{"x":-0.7,"y":-2.3},{"x":0.7,"y":-2.3},{"x":1.4,"y":-0.1},{"x":1,"y":1.5},{"x":-1,"y":1.5},{"x":-1.4,"y":-0.1}]},{"background":"#999999","points":[{"x":-0.7,"y":-2.3},{"x":-0.4,"y":1.5},{"x":0.5,"y":1.5},{"x":0.7,"y":-2.3}]},{"background":"none","points":[{"x":-1.2,"y":4.3},{"x":1.2,"y":4.3},{"x":1,"y":1.5},{"x":-1,"y":1.5}]}]}');class b extends v{constructor(t,e=0,i=0,s=0,n=0){super(t,e,i,s,n),this.rotation=Math.PI/2,this.directionVector={x:0,y:1},this.scaleShape=4,this.shape=f,this.updateCoordinates()}updateCoordinates({x:t,y:e}={}){this.x=t||this.x,this.y=e||this.y}updateDirectionVector(t){this.directionVector=t}animate(){super.animate()}shipShape(){return this.brakedShape||this.shape}}class S extends a{constructor(t,e,i){super(t,e,i),this.score=0,this.textSize=30,this.backgroundColor="#000",this.textColor="#fff",this.lastTime=0}render(t){t.font=`${u(this.textSize)}px Arial`;const e=t.measureText(this.score+""),i=e.width,s=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent;t.beginPath(),t.rect(u(this.x-i-10),u(this.y),u(i+10),u(s+10)),t.fillStyle=this.backgroundColor,t.fill(),t.beginPath(),t.font=`${u(this.textSize)}px Arial`,t.fillStyle=this.textColor,t.fillText(this.score+"",u(this.x-i-5),u(this.y+s+5))}}class E extends a{constructor(t,e,i,s,r,o){super(t,e,i,s,r),this.text=o,this.textSize=10,this.backgroundColor="#000",this.textColor="#fff",this.textColorHover="#9a9a9a",this.listenerEvent("3",(t=>{this.isPositionInside(t.position)&&(document.body.style.cursor="pointer")})),this.listenerEvent(n,(t=>{document.body.style.cursor="default"}))}render(t){t.beginPath(),t.rect(u(this.x),u(this.y),u(this.width),u(this.height)),t.fillStyle=this.backgroundColor,t.fill(),t.beginPath(),t.font=`${u(this.textSize)}px Arial`;const e=t.measureText(this.text),i=d(e.width),s=d(e.actualBoundingBoxAscent+e.actualBoundingBoxDescent);t.fillStyle=this.isMouseHover?this.textColorHover:this.textColor,t.fillText(this.text,u(this.x+this.width/2-i/2),u(this.y+this.height/2+s/2))}}class w extends a{constructor(t,e,i,s,n){super(t,e,i,s,n),this.backgroundColor="#fff",this.textSize=90,this.text2Size=30,this.text="RECORD",this.score=1e3;const r=15;this.createCredits(this.x+r,this.y,40,30),this.createPlayButton(this.x+(this.width-40-120-r)/2,this.y+this.height-30-r,40,30),this.createShareButton(this.x+(this.width-40-120-r)/2+40+r,this.y+this.height-30-r,120,30)}createPlayButton(t,e,i,s){this.buttonPlay=new E(this.eventEmitter,t,e,i,s,"PLAY")}createCredits(t,e,i,n){this.buttonCredits=new E(this.eventEmitter,t,e,i,n,"@ggjnez92"),this.buttonCredits.backgroundColor="#00000000",this.buttonCredits.textColor="#000",this.buttonCredits.textColorHover="#0048ff",this.buttonCredits.listenerEvent(s,(()=>window.open("https://twitter.com/ggjnez92","_blank").focus()))}createShareButton(t,e,i,n){this.buttonShareRecord=new E(this.eventEmitter,t,e,i,n,"SHARE ON TWITTER"),this.buttonShareRecord.listenerEvent(s,(()=>{const t=`https://twitter.com/intent/tweet?text=${`I%20just%20make%20a%20new%20record%20of%20${this.score}%20points%20in%20the%20%23azetz%20%23game%20developed%20for%20the%20%40js13kGames%20competition.%0A%0A%23js13k%20%23gamedev%0A%0AIf%20you%20want%20to%20check%20it%20out%2C%20here%20is%20the%20link%20to%20the%20%23github%20repository%0Ahttps%3A%2F%2Fgithub.com%2Finflagames%2Fazetz`}`;window.open(t,"_blank").focus()}))}render(t){t.beginPath(),t.rect(0,0,u(e),u(i)),t.fillStyle="rgba(0,0,0,0.82)",t.fill(),t.beginPath(),t.rect(u(this.x),u(this.y),u(this.width),u(this.height)),t.fillStyle=this.backgroundColor,t.fill(),this.buttonPlay.render(t),this.buttonCredits.render(t),this.buttonShareRecord.render(t),this.renderScore(t)}renderScore(t){t.beginPath(),t.font=`${u(this.textSize)}px Arial`;const e=t.measureText(this.score+""),i=d(e.width),s=d(e.actualBoundingBoxAscent+e.actualBoundingBoxDescent);t.fillStyle="#000",t.fillText(this.score+"",u(this.x+this.width/2-i/2),u(this.y+this.height/2+s/2)),t.beginPath(),t.font=`${u(this.text2Size)}px Arial`;const n=t.measureText(this.text),r=d(n.width),o=d(n.actualBoundingBoxAscent+n.actualBoundingBoxDescent);t.fillStyle="#000",t.fillText(this.text,u(this.x+this.width/2-r/2),u(this.y+this.height/2+s/2-s-o/2))}}const k="azetzv1_game_score";let P=null;class C{static getInstance(){return P||(P=new C),P}saveScore(t){localStorage.setItem(k,t+"")}getScore(){const t=localStorage.getItem(k);return t?+t:0}}const M={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i)},any:function(){return M.Android()||M.BlackBerry()||M.iOS()||M.Opera()||M.Windows()}};class B{constructor(){this.presedKeys=[]}clear(){this.presedKeys=[]}addKey(t){this.isDirectionKey(t)&&!this.presedKeys.includes(t)&&this.presedKeys.push(t)}removeKey(t){this.presedKeys=this.presedKeys.filter((e=>e!==t))}isDirectionKey(t){return"a"===t||"w"===t||"s"===t||"d"===t}hasPressedKeys(){return this.presedKeys.length>0}directionVector(){let t={x:0,y:0};const e=this.direction();return 1&e?t.y=-1:2&e&&(t.y=1),4&e?t.x=-1:8&e&&(t.x=1),x(t)}direction(){let t=0;if(this.presedKeys.length>0){t=this.directionMap(this.presedKeys[0]);let e=1;for(;e<this.presedKeys.length;){let i=this.consumeNextDirection(1,4,8,t,this.directionMap(this.presedKeys[e]));if(i|=this.consumeNextDirection(2,4,8,t,this.directionMap(this.presedKeys[e])),i|=this.consumeNextDirection(4,1,2,t,this.directionMap(this.presedKeys[e])),i|=this.consumeNextDirection(8,1,2,t,this.directionMap(this.presedKeys[e])),i){t|=i;break}e++}}return t}consumeNextDirection(t,e,i,s,n){return t!==s||n!==e&&n!==i?0:n}directionMap(t){return"w"===t?1:"s"===t?2:"a"===t?4:"d"===t?8:0}}class K{constructor(){this.score=null,this.time=0,this.directionKeys=new B,this.player={position:{x:512,y:384},rotation:Math.PI/2,directionVector:{x:0,y:1},expectedRotation:0,velocity:0,minVelocity:10,acceleration:20,deceleration:-1.5,status:["3"],component:void 0},this.enemies=[],this.objects=[],this.configs={}}destroy(){this.enemies.forEach((t=>t.component.destroy.emit())),this.objects.forEach((t=>t.component.destroy.emit())),this.player.component.destroy.emit()}play(){this.movePlayer(),this.animateComponents()}movePlayer(){if(this.directionKeys.hasPressedKeys()){const r=(i=this.player.directionVector,s=this.directionKeys.directionVector(),n=.95,{x:i.x+(s.x-i.x)*n,y:i.y+(s.y-i.y)*n});this.player.directionVector=(t=x(r),e=10,{x:t.x*e,y:t.y*e}),this.player.position=function(t,e){return{x:t.x+e.x,y:t.y+e.y}}(this.player.directionVector,this.player.position)}var t,e,i,s,n;this.player.component.updateCoordinates(this.player.position),this.player.component.updateDirectionVector({...this.player.directionVector,y:-this.player.directionVector.y})}canPauseGame(){return!0}animateComponents(){}pause(){}unpause(){}updateSpaces(){}updateScore(){}getScore(){}checkCollision(){}checkCollisionInProjections(t,e){for(const i of t)for(const t of e)if(y(i.points,t.points))return!0;return!1}}class A extends a{constructor(t,e=0,i=0,s=0,n=0,r=""){super(t,e,i,s,n),this.backgroundColor=r}render(t){this.backgroundColor&&(t.beginPath(),t.fillStyle=this.backgroundColor,t.rect(0,0,u(this.width),u(this.height)),t.fill())}}M.any();class I extends c{constructor(t,e){super(t,e),this.buttonPause=new E(this.eventEmitter,10,10,60,30,"PAUSE"),this.buttonPause.textSize=20,this.buttonPause.listenerEvent(s,(()=>{this.currentGame.canPauseGame()&&(this.currentGame.pause(),this.showModal(C.getInstance().getScore(),!1))})),this.listenerEvent(r,this.keyDown.bind(this)),this.listenerEvent(o,this.keyUp.bind(this)),this.initGame()}initGame(){this.isModalShow=!1,this.currentGame&&this.currentGame.destroy(),this.currentGame=new K,this.player=new b(this.eventEmitter,512,384,30,35),this.currentGame.player.component=this.player,this.level=new A(this.eventEmitter,0,0,e,i,"#000");const t=new S(this.eventEmitter,1014,10);this.currentGame.score=t,this.elements=[this.player,this.buttonPause],this.elements.push(t),this.playableElements=[this.player]}render(t){this.currentGame.play(),this.cleanCanvas(t),this.renderOrRemovePlayableElements(t);for(const e of this.elements)e.render(t)}keyDown(t){this.currentGame.directionKeys.addKey(t.key)}keyUp(t){this.currentGame.directionKeys.removeKey(t.key)}showModal(t,e=!0){if(!this.isModalShow){this.isModalShow=!0;const i=300,s=200,n=new w(this.eventEmitter,512-i/2,384-i/2,i,s);C.getInstance().saveScore(Math.max(C.getInstance().getScore(),t)),n.score=t,n.buttonPlay.listenerEvent("2",(()=>{n.buttonPlay.destroy.emit(),n.buttonShareRecord.destroy.emit(),n.buttonCredits.destroy.emit(),this.currentGame.unpause(),this.elements.pop(),this.isModalShow=!1,e&&this.initGame()})),this.elements.push(n)}}renderOrRemovePlayableElements(t){const e=new Set;for(const i of this.playableElements)this.isElementVisible(i)?i.render(t):e.add(i.id);this.playableElements=this.playableElements.filter((t=>!e.has(t.id)))}isElementVisible(t){return t.y-2*t.height<i}cleanCanvas(t){this.level.render(t)}}class T{constructor(t,i){this.gameWidth=e,this.gameHeght=768,this.sceneClasses=new Map,this.sceneClasses.set(1,I),this.scenesInstances=new Map,this.currentScene=null,i.on((t=>{this.currentScene.eventEmitter.emit(t),"8"===t.event&&t.dimension&&(this.gameWidth=t.dimension.w,this.gameHeght=t.dimension.h,this.updateGameDimensions())})),this.navigate(t)}navigate(t){this.scenesInstances.has(t)?this.currentScene=this.scenesInstances.get(t):this.sceneClasses.has(t)&&(this.scenesInstances.set(t,new(this.sceneClasses.get(t))(this,new h)),this.currentScene=this.scenesInstances.get(t)),this.updateGameDimensions()}updateGameDimensions(){this.currentScene&&(this.currentScene.width=this.gameWidth,this.currentScene.height=this.gameHeght)}}const z=1e3/30;let D=null;class G{constructor(){window.addEventListener("resize",this.resizeScreen.bind(this)),this.canvas=document.getElementById("game"),this.registerEvents(),this.eventEmitter=new h,this.context=this.canvas.getContext("2d"),this.navigatorRoot=new T(1,this.eventEmitter),this.loopStatus=3,this.lastTime=0,this.width=this.canvas.width,this.height=this.canvas.height,this.resizeScreen()}registerEvents(){this.registerKeyboardEvent("keydown",r),this.registerKeyboardEvent("keyup",o),this.registerKeyboardEvent("keypress","9"),this.registerClickEvent("click",s),this.registerClickEvent("mousedown","1"),this.registerClickEvent("mouseup","2"),this.registerClickEvent("mouseout",n),this.registerClickEvent("mouseleave","9"),this.registerClickEvent("mousemove","3"),this.registerTouchEvent("touchstart","4",!1),this.registerTouchEvent("touchend","5",!1),this.registerTouchEvent("touchcancel","7",!1),this.registerTouchEvent("touchmove","6",!1)}registerClickEvent(t,e,i=void 0){this.canvas.addEventListener(t,(t=>this.clickEvent(t,e)),i)}registerTouchEvent(t,e,i=void 0){this.canvas.addEventListener(t,(t=>this.touchEvent(t,e)),i)}registerKeyboardEvent(t,e,i=void 0){document.addEventListener(t,(t=>this.keyboardEvent(t,e)),i)}resizeScreen(){const i=window.innerWidth,s=window.innerHeight;let n=Math.min(e,i),r=n*t;r>s&&(r=s,n=s/t),this.canvas.width=n,this.canvas.height=r,window.currentWidth=n,this.eventEmitter.emit({event:"8",dimension:{w:n,h:r}})}touchEvent(t,e){this.emitPositionEvent({x:t?.targetTouches[0]?.pageX,y:t?.targetTouches[0]?.pageY},e)}clickEvent(t,e){this.emitPositionEvent({x:t?.clientX,y:t?.clientY},e)}keyboardEvent(t,e){this.eventEmitter.emit({event:e,key:t.key})}emitPositionEvent(t,e){const i=this.canvas.getBoundingClientRect();this.eventEmitter.emit({event:e,position:{x:d(t.x-i.left),y:d(t.y-i.top)}})}static getInstance(){return D||(D=new G),D}init(){this.loopStatus=1,requestAnimationFrame(this.loop.bind(this))}loop(t){1===this.loopStatus&&(1===this.loopStatus&&z<=t-this.lastTime&&(this.lastTime=t,this.navigatorRoot.currentScene.render(this.context)),requestAnimationFrame(this.loop.bind(this)))}}G.getInstance().init()})()})();
//# sourceMappingURL=main.js.map